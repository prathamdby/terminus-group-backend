<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0"
        />
        <title>Projects Form</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
        <script
            type="module"
            src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
        ></script>
        <script
            nomodule
            src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
        ></script>
    </head>
    <body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
        <div class="max-w-4xl mx-auto px-4 py-8 sm:py-12">
            <a
                href="index.html"
                class="inline-flex items-center text-blue-600 hover:text-blue-700 mb-6 group"
            >
                <svg
                    class="w-5 h-5 mr-2 transform group-hover:-translate-x-1 transition-transform"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"
                    />
                </svg>
                <span class="text-lg font-semibold">Back to Dashboard</span>
            </a>

            <div class="bg-white rounded-2xl shadow-sm p-6 sm:p-8">
                <h1
                    class="text-2xl sm:text-3xl font-bold text-gray-800 mb-8"
                    id="formTitle"
                >
                    Add New Project
                </h1>

                <form
                    id="projectForm"
                    class="space-y-6"
                >
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Title -->
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                                for="title"
                            >
                                Title *
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                id="title"
                                type="text"
                                required
                            />
                        </div>

                        <!-- Location -->
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                                for="location"
                            >
                                Location *
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                id="location"
                                type="text"
                                required
                            />
                        </div>

                        <!-- Year of Completion -->
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                                for="yearOfCompletion"
                            >
                                Year of Completion *
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                id="yearOfCompletion"
                                type="number"
                                required
                            />
                        </div>

                        <!-- Built Up Area -->
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                                for="builtUpArea"
                            >
                                Built Up Area (sq ft) *
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                id="builtUpArea"
                                type="text"
                                required
                            />
                        </div>

                        <!-- Status -->
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                                for="status"
                            >
                                Status *
                            </label>
                            <select
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                id="status"
                                required
                            >
                                <option value="">Select Status</option>
                                <option value="completed">Completed</option>
                                <option value="in-progress">Ongoing</option>
                                <option value="planned">Launching soon</option>
                            </select>
                        </div>

                        <!-- Type -->
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                                for="type"
                            >
                                Type *
                            </label>
                            <select
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                id="type"
                                required
                            >
                                <option value="">Select Type</option>
                                <option value="residential">Residential</option>
                                <option value="commercial">Commercial</option>
                                <option value="hospitality">Hospitality</option>
                                <option value="life_sciences">Life Sciences</option>
                            </select>
                        </div>

                        <!-- Description -->
                        <div class="md:col-span-2">
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                                for="description"
                            >
                                Description *
                            </label>
                            <textarea
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                id="description"
                                rows="4"
                                required
                            ></textarea>
                        </div>

                        <!-- Architect -->

                        <!-- Structural Engineer -->

                        <!-- Project Management -->

                        <!-- Images -->
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                                for="images"
                            >
                                Images (Max 5) *
                            </label>
                            <div
                                class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-gray-400 transition-colors"
                            >
                                <div class="space-y-1 text-center">
                                    <svg
                                        class="mx-auto h-12 w-12 text-gray-400"
                                        stroke="currentColor"
                                        fill="none"
                                        viewBox="0 0 48 48"
                                    >
                                        <path
                                            d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                        />
                                    </svg>
                                    <div class="flex text-sm text-gray-600">
                                        <label
                                            for="images"
                                            class="relative cursor-pointer rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none"
                                        >
                                            <span>Upload images</span>
                                            <input
                                                id="images"
                                                type="file"
                                                class="sr-only"
                                                multiple
                                                accept="image/*"
                                                onchange="previewImage(event)"
                                                maxlength="5"
                                            />
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                                </div>
                            </div>
                        </div>

                        <!-- Brochure -->
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                                for="brochure"
                            >
                                Brochure
                            </label>
                            <div
                                class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-gray-400 transition-colors"
                            >
                                <div class="space-y-1 text-center">
                                    <svg
                                        class="mx-auto h-12 w-12 text-gray-400"
                                        stroke="currentColor"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                                        />
                                    </svg>
                                    <div class="flex text-sm text-gray-600">
                                        <label
                                            for="brochure"
                                            class="relative cursor-pointer rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none"
                                        >
                                            <span>Upload brochure</span>
                                            <input
                                                id="brochure"
                                                type="file"
                                                class="sr-only"
                                                accept="application/pdf"
                                            />
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500">PDF up to 10MB</p>
                                </div>
                            </div>
                        </div>

                        <!-- Image Preview -->
                        <div
                            id="imagePreview"
                            class="hidden mt-4 items-center flex-col gap-4 overflow-hidden flex-wrap relative"
                        ></div>

                        <!-- Secondary Summary -->
                        <div class="md:col-span-2">
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                                for="secondarySummary"
                            >
                                Secondary Summary
                            </label>
                            <textarea
                                id="secondarySummary"
                                rows="4"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                            ></textarea>
                        </div>

                        <!-- YouTube Video URL -->
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-2"
                                for="youtubeVideo"
                            >
                                YouTube Video URL
                            </label>
                            <input
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                id="youtubeVideo"
                                type="url"
                                pattern="https?://.*"
                                placeholder="https://youtube.com/..."
                            />
                        </div>

                        <!-- Tags -->
                        <!-- <div>
              <label
                class="block text-sm font-medium text-gray-700 mb-2"
                for="tags"
              >
                Tags (comma-separated)
              </label>
              <input
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                id="tags"
                type="text"
                placeholder="residential, modern, sustainable"
              />
            </div> -->
                    </div>

                    <div class="flex justify-end pt-6">
                        <button
                            type="submit"
                            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                        >
                            Save Project
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            let imageFiles = [];

            const preview = document.getElementById("imagePreview");

            function previewImage(event) {
                const input = event.target;
                preview.innerHTML = ""; // Clear previous images
                imageFiles = Array.from(input.files); // Store the files

                if (input.files && input.files.length > 0) {
                    if (input.files.length > 5) {
                        alert("You can only upload a maximum of 5 images.");
                        input.value = ""; // Clear the input
                        return;
                    }

                    for (let i = 0; i < input.files.length; i++) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const wrapper = document.createElement("div");
                            const img = document.createElement("img");
                            const close = document.createElement("ion-icon");
                            close.setAttribute("name", "close-outline");
                            close.classList.add(
                                "size-8",
                                "text-red-600",
                                "absolute",
                                "top-7",
                                "right-3",
                                "cursor-pointer"
                            );
                            close.onclick = function () {
                                const index = Array.from(preview.children).indexOf(wrapper);
                                imageFiles.splice(index, 1); // Remove the file from the array
                                preview.removeChild(wrapper);
                                if (preview.children.length === 0) {
                                    input.value = "";
                                    preview.style.display = "none";
                                }
                            };
                            img.src = e.target.result;
                            img.classList.add("mt-4", "w-full", "h-auto", "rounded-lg", "object-cover", "relative");
                            wrapper.classList.add("relative");
                            wrapper.appendChild(img);
                            wrapper.appendChild(close);
                            preview.appendChild(wrapper);
                        };
                        reader.readAsDataURL(input.files[i]);
                    }
                    preview.style.display = "flex";
                } else {
                    preview.style.display = "none";
                }
            }

            document.addEventListener("DOMContentLoaded", function () {
                const preview = document.getElementById("imagePreview");
                new Sortable(preview, {
                    animation: 150,
                    ghostClass: "sortable-ghost",
                    onEnd: function (evt) {
                        const movedItem = imageFiles.splice(evt.oldIndex, 1)[0];
                        imageFiles.splice(evt.newIndex, 0, movedItem);
                    },
                });
            });

            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get("id");

            const form = document.getElementById("projectForm");
            const formTitle = document.getElementById("formTitle");

            if (projectId) {
                formTitle.textContent = "Edit Project";

                fetch(`/forms/project/${projectId}`)
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error("Failed to fetch project data.");
                        }
                        return response.json();
                    })
                    .then((data) => {
                        // Pre-fill form fields
                        form.title.value = data.title;
                        form.location.value = data.location;
                        form.yearOfCompletion.value = data.yearOfCompletion;
                        form.builtUpArea.value = data.builtUpArea;
                        form.description.value = data.description;
                        form.status.value = data.status;
                        form.type.value = data.type;
                        // form.architect.value = data.architect;
                        // form.landscapeArchitect.value = data.landscapeArchitect || "";
                        // form.structuralEngineer.value = data.structuralEngineer || "";
                        // form.projectManagement.value = data.projectManagement || "";
                        // form.consultants.value = data.consultants
                        //   ? data.consultants.join(", ")
                        //   : "";
                        form.secondarySummary.value = data.secondarySummary || "";
                        form.youtubeVideo.value = data.youtubeVideoUrl || "";
                        // form.tags.value = data.tags ? data.tags.join(", ") : "";

                        // Update image labels
                        const imagesLabel = document.querySelector('label[for="images"] span');
                        imagesLabel.textContent = "Upload new images (optional)";

                        const brochureLabel = document.querySelector('label[for="brochure"] span');
                        brochureLabel.textContent = "Upload new brochure (optional)";
                    })
                    .catch((error) => {
                        console.error("Error fetching project data:", error);
                        alert("Failed to load project data. Please try again.");
                    });
            }

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const formData = new FormData();

                // Add text fields
                formData.append("title", form.title.value);
                formData.append("location", form.location.value);
                formData.append("yearOfCompletion", form.yearOfCompletion.value);
                formData.append("builtUpArea", form.builtUpArea.value);
                formData.append("description", form.description.value);
                formData.append("status", form.status.value);
                formData.append("type", form.type.value);
                // formData.append("architect", form.architect.value);
                // formData.append("landscapeArchitect", form.landscapeArchitect.value);
                // formData.append("structuralEngineer", form.structuralEngineer.value);
                // formData.append("projectManagement", form.projectManagement.value);
                // formData.append("consultants", form.consultants.value);
                formData.append("secondarySummary", form.secondarySummary.value);
                formData.append("youtubeVideoUrl", form.youtubeVideo.value);
                // formData.append("tags", form.tags.value);

                imageFiles.forEach((file, index) => {
                    formData.append("images", file);
                });

                if (form.brochure.files[0]) {
                    formData.append("brochure", form.brochure.files[0]);
                }

                try {
                    let response;
                    if (projectId) {
                        response = await fetch(`/forms/project/${projectId}`, {
                            method: "PUT",
                            body: formData,
                        });
                    } else {
                        response = await fetch("/forms/project", {
                            method: "POST",
                            body: formData,
                        });
                    }

                    if (!response.ok) {
                        throw new Error(projectId ? "Failed to update project." : "Failed to add project.");
                    }

                    alert(projectId ? "Project updated successfully!" : "Project submitted successfully!");
                    if (projectId) {
                        window.location.href = "manage.html";
                    } else {
                        form.reset();
                        preview.style.display = "none";
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert(
                        projectId
                            ? "Failed to update project. Please try again."
                            : "Failed to submit project. Please try again."
                    );
                }
            });
        </script>
    </body>
</html>
